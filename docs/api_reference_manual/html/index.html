<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cypress Secure Sockets: Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="cypress_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cypress Secure Sockets</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This library provides network abstraction APIs for underlying network and security library. Secure sockets library eases application development by exposing a socket like interface for both secure and non-secure socket communication</p>
<h1><a class="anchor" id="section_features"></a>
Features and Functionality</h1>
<p>The current implementation supports the following:</p><ul>
<li>Non-secure TCP communication with lwIP network stack</li>
<li>Secure (TLS) communication using Mbed TLS library</li>
<li>Supports TCP/IPv4 connections. UDP and IPv6 will be supported in future.</li>
<li>Provides thread-safe APIs</li>
<li>Provides APIs to support both client and server mode operations</li>
<li>Supports both synchronous and asynchronous APIs for data receive. Asynchronous mode support for server to accept client connections</li>
<li>Provides socket-option API to configure send/receive timeout, callback for asynchronous mode, TCP keepalive parameters, certificate/key, and TLS extensions</li>
</ul>
<h1><a class="anchor" id="section_platforms"></a>
Supported Platforms</h1>
<p>This library and its features are supported on the following Cypress platforms:</p><ul>
<li><a href="https://www.cypress.com/documentation/development-kitsboards/psoc-6-wi-fi-bt-prototyping-kit-cy8cproto-062-4343w">PSoC6 WiFi-BT Prototyping Kit (CY8CPROTO-062-4343W)</a></li>
<li><a href="https://www.cypress.com/documentation/development-kitsboards/psoc-62s2-wi-fi-bt-pioneer-kit-cy8ckit-062s2-43012">PSoC 62S2 Wi-Fi BT Pioneer Kit (CY8CKIT-062S2-43012)</a></li>
</ul>
<h1><a class="anchor" id="section_integration"></a>
Integration Notes</h1>
<ul>
<li>Cypress Secure Sockets Library configures default send and receive timeout values to 10 seconds for a newly created socket. Default timeout values can be changed by modifying DEFAULT_SEND_TIMEOUT and DEFAULT_RECV_TIMEOUT macros in the cy_secure_sockets.h file. To configure the timeout values specific to socket, use the cy_socket_setsockopt API function. To change the send timeout, use the CY_SOCKET_SO_SNDTIMEO socket option; similarly, for receive timeout, use the CY_SOCKET_SO_RCVTIMEO socket option. Adjust the default timeout values based on the network speed or use case.</li>
<li>Cypress secure sockets library has been designed to support different flavors of TCP/IP stack or security stack. Currently, lwIP and MbedTLS are the default network and security stacks respectively. Therefore, any application that uses secure sockets must ensure that the following COMPONENTS are defined in the code example project's Makefile - LWIP and MBEDTLS.</li>
<li>Cypress secure sockets and TLS libraries enable only error prints by default. For debugging purposes, the application may additionally enable debug and info log messages. To enable these messages, add SECURE_SOCKETS_ENABLE_PRINT_LIBRARY_INFO, SECURE_SOCKETS_ENABLE_PRINT_LIBRARY_DEBUG, TLS_ENABLE_PRINT_LIBRARY_INFO, and TLS_ENABLE_PRINT_LIBRARY_DEBUG macros to the DEFINES in the code example's Makefile. The Makefile entry would look like, <div class="fragment"><div class="line">DEFINES+=SECURE_SOCKETS_ENABLE_PRINT_LIBRARY_INFO SECURE_SOCKETS_ENABLE_PRINT_LIBRARY_DEBUG</div><div class="line">DEFINES+=TLS_ENABLE_PRINT_LIBRARY_INFO TLS_ENABLE_PRINT_LIBRARY_DEBUG</div></div><!-- fragment --></li>
<li>In order to ease integration of Wi-Fi connectivity components to code examples, this secure socket library has been bundled into the <a href="https://github.com/cypresssemiconductorco/wifi-mw-core">Wi-Fi Middleware Core Library v2.0.0</a></li>
</ul>
<h1><a class="anchor" id="section_code_snippet"></a>
Code Snippets</h1>
<h2><a class="anchor" id="snip1"></a>
Code Snippet1: Create TCP Socket</h2>
<p>This code snippet demonstrates how to initialize and create a TCP socket. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> snippet_create_socket()</div><div class="line">{</div><div class="line">    cy_rslt_t result;</div><div class="line"></div><div class="line">    <span class="comment">/* TCP socket handle */</span></div><div class="line">    <a class="code" href="group__group__secure__sockets__typedefs.html#ga12b5aa294d6c930ba50ab730d39ed511">cy_socket_t</a> socket_handle;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the Secure Sockets library. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga49a49b4e3b4293aa3855f47ce831ebe2">cy_socket_init</a>();</div><div class="line"></div><div class="line">    <span class="comment">/* Create a TCP socket. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga30bbbf20a277e2a7e622df504b014a4b">cy_socket_create</a>(<a class="code" href="group__group__secure__sockets__macros.html#gacc301fb73845cb915cfacffc1b7d0c23">CY_SOCKET_DOMAIN_AF_INET</a>, <a class="code" href="group__group__secure__sockets__macros.html#gac0610ba6e8fe01ccbaacf89145f9285a">CY_SOCKET_TYPE_STREAM</a>, <a class="code" href="group__group__secure__sockets__macros.html#ga1c6d23edbc333c85d3e7a8702dcf22a1">CY_SOCKET_IPPROTO_TCP</a>, &amp;socket_handle);</div><div class="line">}</div></div><!-- fragment --> <h2><a class="anchor" id="snip2"></a>
Code Snippet2: Create Secure Socket</h2>
<p>This code snippet demonstrates how to initialize and create a TCP socket and set the TLS credentials to be used for securing the socket communication. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> snippet_create_secure_socket()</div><div class="line">{</div><div class="line">    cy_rslt_t result;</div><div class="line"></div><div class="line">    <span class="comment">/* TCP socket handle */</span></div><div class="line">    <a class="code" href="group__group__secure__sockets__typedefs.html#ga12b5aa294d6c930ba50ab730d39ed511">cy_socket_t</a> socket_handle;</div><div class="line"></div><div class="line">    <span class="comment">/* Variable to store the TLS identity (certificate and private key).*/</span></div><div class="line">    <span class="keywordtype">void</span> *tls_identity;</div><div class="line"></div><div class="line">    <span class="comment">/* TLS authentication mode. Setting CY_SOCKET_TLS_VERIFY_REQUIRED authentication mode</span></div><div class="line"><span class="comment">    requires a successful TLS handshake in order to establish a secure socket communication*/</span></div><div class="line">    <a class="code" href="group__group__secure__sockets__enums.html#gaf0599f554a1154ae83b4f587520fa705">cy_socket_tls_auth_mode_t</a> tls_auth_mode = <a class="code" href="group__group__secure__sockets__enums.html#ggaf0599f554a1154ae83b4f587520fa705a68f0cd442bb9f64416a6351f6d8c5a78">CY_SOCKET_TLS_VERIFY_REQUIRED</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize with your TLS certificate. Must include the PEM header and footer*/</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> tls_cert[] = <span class="stringliteral">&quot;-----REPLACE WITH TLS CERTIFICATE FILE-----\n&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize with private key corresponding to the TLS ceritificate used.</span></div><div class="line"><span class="comment">    * Must include the PEM header and footer. */</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> private_key[] = <span class="stringliteral">&quot;-----REPLACE WITH PRIVATE KEY-----\n&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* TLS certificate length and private key length. */</span></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> cert_len = strlen( tls_cert );</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> pkey_len = strlen( private_key );</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the Secure Sockets library. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga49a49b4e3b4293aa3855f47ce831ebe2">cy_socket_init</a>();</div><div class="line"></div><div class="line">    <span class="comment">/* Create a new secure TCP socket. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga30bbbf20a277e2a7e622df504b014a4b">cy_socket_create</a>(<a class="code" href="group__group__secure__sockets__macros.html#gacc301fb73845cb915cfacffc1b7d0c23">CY_SOCKET_DOMAIN_AF_INET</a>, <a class="code" href="group__group__secure__sockets__macros.html#gac0610ba6e8fe01ccbaacf89145f9285a">CY_SOCKET_TYPE_STREAM</a>, <a class="code" href="group__group__secure__sockets__macros.html#ga1114a6ecf098cf499e2c9ad3d651efc3">CY_SOCKET_IPPROTO_TLS</a>, &amp;socket_handle);</div><div class="line"></div><div class="line">    <span class="comment">/* Create TCP client identity using the SSL certificate and private key. */</span></div><div class="line">    result = <a class="code" href="group__group__cy__tls__functions.html#ga3d2408681bbcea3b869cb5ae21cd0d5e">cy_tls_create_identity</a>(tls_cert, cert_len, private_key, pkey_len, &amp;tls_identity);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the TCP socket to use the TLS identity. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga02e453d715d77075c59d751f6b07ae8f">cy_socket_setsockopt</a>(socket_handle, <a class="code" href="group__group__secure__sockets__macros.html#ga87878a7761a845f17f24f5e52c73f61f">CY_SOCKET_SOL_TLS</a>, <a class="code" href="group__group__secure__sockets__macros.html#gafa0ac839774a33feeb037dbb0c449cc3">CY_SOCKET_SO_TLS_IDENTITY</a>, tls_identity, <span class="keyword">sizeof</span>(tls_identity));</div><div class="line"></div><div class="line">    <span class="comment">/* Set the TLS authentication mode. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga02e453d715d77075c59d751f6b07ae8f">cy_socket_setsockopt</a>(socket_handle, <a class="code" href="group__group__secure__sockets__macros.html#ga87878a7761a845f17f24f5e52c73f61f">CY_SOCKET_SOL_TLS</a>, <a class="code" href="group__group__secure__sockets__macros.html#ga9ce4ab8fca2ff7306f05f7433835f394">CY_SOCKET_SO_TLS_AUTH_MODE</a>, &amp;tls_auth_mode, <span class="keyword">sizeof</span>(<a class="code" href="group__group__secure__sockets__enums.html#gaf0599f554a1154ae83b4f587520fa705">cy_socket_tls_auth_mode_t</a>));</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="snip3"></a>
Code Snippet3: TCP Client Connect</h2>
<p>This code snippet demonstrates how to create a TCP client socket and initiate communication with a TCP server. </p><div class="fragment"><div class="line"> </div><div class="line"><span class="preprocessor">#define MAKE_IPV4_ADDRESS(a, b, c, d)     ((((uint32_t) d) &lt;&lt; 24) | \</span></div><div class="line"><span class="preprocessor">                                          (((uint32_t) c) &lt;&lt; 16) | \</span></div><div class="line"><span class="preprocessor">                                          (((uint32_t) b) &lt;&lt; 8) |\</span></div><div class="line"><span class="preprocessor">                                          ((uint32_t) a))</span></div><div class="line"></div><div class="line"><span class="comment">/* Change the server IP address and port number to match the TCP server address to which</span></div><div class="line"><span class="comment"> * client wants to connect to.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#define TCP_SERVER_IP_ADDRESS                     MAKE_IPV4_ADDRESS(192, 168, 18, 9)</span></div><div class="line"><span class="preprocessor">#define TCP_SERVER_PORT                           (50007)</span></div><div class="line"></div><div class="line"><span class="comment">/* Buffer size to store the incoming messages from server. */</span></div><div class="line"><span class="preprocessor">#define MAX_TCP_RECV_BUFFER_SIZE                  (20)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define RTOS_TASK_TICKS_TO_WAIT                   (1000)</span></div><div class="line"></div><div class="line"><span class="comment">/* TCP socket handle */</span></div><div class="line"><a class="code" href="group__group__secure__sockets__typedefs.html#ga12b5aa294d6c930ba50ab730d39ed511">cy_socket_t</a> client_handle;</div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> send_msg_to_server;</div><div class="line"></div><div class="line"><span class="comment">/* Function to handle incoming  message from TCP server. */</span></div><div class="line">cy_rslt_t tcp_client_recv_handler(<a class="code" href="group__group__secure__sockets__typedefs.html#ga12b5aa294d6c930ba50ab730d39ed511">cy_socket_t</a> client_handle, <span class="keywordtype">void</span> *arg)</div><div class="line">{</div><div class="line">    cy_rslt_t result ;</div><div class="line"></div><div class="line">    <span class="comment">/* Variable to store the number of bytes received. */</span></div><div class="line">    uint32_t bytes_received = 0;</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span> rx_buffer[MAX_TCP_RECV_BUFFER_SIZE];</div><div class="line"></div><div class="line">    <span class="comment">/* Receive incoming message from TCP server. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#gaeb1269bd36384293539dc749095412f7">cy_socket_recv</a>(client_handle, rx_buffer, MAX_TCP_RECV_BUFFER_SIZE,</div><div class="line">                            <a class="code" href="group__group__secure__sockets__macros.html#ga91444208828cd6b96895d64b879513d4">CY_SOCKET_FLAGS_NONE</a>, &amp;bytes_received);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the flag to send a message to TCP server*/</span></div><div class="line">    send_msg_to_server = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_tcp_client()</div><div class="line">{</div><div class="line">    cy_rslt_t result;</div><div class="line"></div><div class="line">    <span class="comment">/* Variable to store the number of bytes sent to the TCP server. */</span></div><div class="line">    uint32_t bytes_sent = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* IP address and TCP port number of the TCP server */</span></div><div class="line">    <a class="code" href="structcy__socket__sockaddr__t.html">cy_socket_sockaddr_t</a> tcp_server_addr = {</div><div class="line">        .<a class="code" href="structcy__socket__sockaddr__t.html#ac4caf040376b30c85ca9065a20d5616c">ip_address</a>.<a class="code" href="structcy__socket__ip__address__t.html#a935806d84abf86ee6a8dcbfdeb6940a4">ip</a>.<a class="code" href="structcy__socket__ip__address__t.html#a1b68b61521bd0b095ed35bea52f6fd82">v4</a> = TCP_SERVER_IP_ADDRESS,</div><div class="line">        .ip_address.version = <a class="code" href="group__group__secure__sockets__enums.html#gga97cb501a58195859467b126cf2a2789da32785b59f763a33cac58932132a90520">CY_SOCKET_IP_VER_V4</a>,</div><div class="line">        .port = TCP_SERVER_PORT</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="comment">/* Buffer to hold data to be sent to client. */</span></div><div class="line">    <span class="keywordtype">char</span> tx_buffer[] = <span class="stringliteral">&quot;Message to TCP server&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the Secure Sockets library. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga49a49b4e3b4293aa3855f47ce831ebe2">cy_socket_init</a>();</div><div class="line"></div><div class="line">    <span class="comment">/* Create a TCP socket. If you need a secure connection, create a secure socket</span></div><div class="line"><span class="comment">     * as demonstrated by snippet_create_secure_socket function. </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga30bbbf20a277e2a7e622df504b014a4b">cy_socket_create</a>(<a class="code" href="group__group__secure__sockets__macros.html#gacc301fb73845cb915cfacffc1b7d0c23">CY_SOCKET_DOMAIN_AF_INET</a>, <a class="code" href="group__group__secure__sockets__macros.html#gac0610ba6e8fe01ccbaacf89145f9285a">CY_SOCKET_TYPE_STREAM</a>, <a class="code" href="group__group__secure__sockets__macros.html#ga1c6d23edbc333c85d3e7a8702dcf22a1">CY_SOCKET_IPPROTO_TCP</a>, &amp;client_handle);</div><div class="line"></div><div class="line">    <span class="comment">/* Variable used to set socket options. */</span></div><div class="line">    <a class="code" href="structcy__socket__opt__callback__t.html">cy_socket_opt_callback_t</a> tcp_recv_option = {</div><div class="line">        .<a class="code" href="structcy__socket__opt__callback__t.html#a7f321e77df24f3b06ade13f44ce43053">callback</a> = tcp_client_recv_handler,</div><div class="line">        .arg = NULL</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="comment">/* Register the callback function to handle messages received from TCP server. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga02e453d715d77075c59d751f6b07ae8f">cy_socket_setsockopt</a>(client_handle, <a class="code" href="group__group__secure__sockets__macros.html#gaf36b6f0f1bc53927d148746fedad7149">CY_SOCKET_SOL_SOCKET</a>,</div><div class="line">                                  <a class="code" href="group__group__secure__sockets__macros.html#gaa05dc49b1682f0682d1a4066c641512d">CY_SOCKET_SO_RECEIVE_CALLBACK</a>,</div><div class="line">                                  &amp;tcp_recv_option, <span class="keyword">sizeof</span>(<a class="code" href="structcy__socket__opt__callback__t.html">cy_socket_opt_callback_t</a>));</div><div class="line"></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga2e07189d60c7e6a130302d2e2db19653">cy_socket_connect</a>(client_handle, &amp;tcp_server_addr, <span class="keyword">sizeof</span>(<a class="code" href="structcy__socket__sockaddr__t.html">cy_socket_sockaddr_t</a>));</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span>(;;)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span>(send_msg_to_server)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Send message to TCP server. */</span></div><div class="line">            result = <a class="code" href="group__group__secure__sockets__functions.html#gaf6ba24a0e4e6eb3c24087938aa3ae021">cy_socket_send</a>(client_handle, tx_buffer, strlen(tx_buffer),</div><div class="line">                        <a class="code" href="group__group__secure__sockets__macros.html#ga91444208828cd6b96895d64b879513d4">CY_SOCKET_FLAGS_NONE</a>, &amp;bytes_sent);</div><div class="line"></div><div class="line">            <span class="comment">/*Close the connection*/</span></div><div class="line">            result = <a class="code" href="group__group__secure__sockets__functions.html#ga97476da4dcc2f3a411c35b741bf098cc">cy_socket_disconnect</a>(client_handle, 0);</div><div class="line"></div><div class="line">            <span class="comment">/* Delete the socket and free the resources allocated to the socket. */</span></div><div class="line">            result = <a class="code" href="group__group__secure__sockets__functions.html#ga3c811410848871c3c4b0721a3b37dc24">cy_socket_delete</a>(client_handle);</div><div class="line"></div><div class="line">            <span class="comment">/* Clear the flag to send message to TCP server.*/</span></div><div class="line">            send_msg_to_server = <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        vTaskDelay(RTOS_TASK_TICKS_TO_WAIT);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> <h2><a class="anchor" id="snip4"></a>
Code Snippet4: TCP Server - Listening for client connection</h2>
<p>This code snippet demonstrates how to create a TCP server socket and accept a TCP client connection to communicate. </p><div class="fragment"><div class="line"><span class="preprocessor">#define MAKE_IPV4_ADDRESS(a, b, c, d)     ((((uint32_t) d) &lt;&lt; 24) | \</span></div><div class="line"><span class="preprocessor">                                          (((uint32_t) c) &lt;&lt; 16) | \</span></div><div class="line"><span class="preprocessor">                                          (((uint32_t) b) &lt;&lt; 8) |\</span></div><div class="line"><span class="preprocessor">                                          ((uint32_t) a))</span></div><div class="line"></div><div class="line"><span class="comment">/* Change the server IP address and port to match the TCP server address </span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#define TCP_SERVER_IP_ADDRESS                     MAKE_IPV4_ADDRESS(192, 168, 18, 9)</span></div><div class="line"><span class="preprocessor">#define TCP_SERVER_PORT                           (50007)</span></div><div class="line"></div><div class="line"><span class="comment">/* Maximum number of incoming connections. */</span></div><div class="line"><span class="preprocessor">#define TCP_SERVER_MAX_PENDING_CONNECTIONS        (3)</span></div><div class="line"></div><div class="line"><span class="comment">/* Buffer size to store the incoming messages from client. */</span></div><div class="line"><span class="preprocessor">#define MAX_TCP_RECV_BUFFER_SIZE                  (20)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define RTOS_TASK_TICKS_TO_WAIT                   (1000)</span></div><div class="line"></div><div class="line"><span class="comment">/* TCP socket handles */</span></div><div class="line"><a class="code" href="group__group__secure__sockets__typedefs.html#ga12b5aa294d6c930ba50ab730d39ed511">cy_socket_t</a> server_handle, client_handle;</div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> send_msg_to_client;</div><div class="line"></div><div class="line"><span class="comment">/* Incoming TCP client connection handler. */</span></div><div class="line">cy_rslt_t tcp_connection_handler(<a class="code" href="group__group__secure__sockets__typedefs.html#ga12b5aa294d6c930ba50ab730d39ed511">cy_socket_t</a> socket_handle, <span class="keywordtype">void</span> *arg)</div><div class="line">{</div><div class="line">    cy_rslt_t result;</div><div class="line"></div><div class="line">    <span class="comment">/* Client socket address. */</span></div><div class="line">    <a class="code" href="structcy__socket__sockaddr__t.html">cy_socket_sockaddr_t</a> client_addr;</div><div class="line"></div><div class="line">    <span class="comment">/* Size of the client socket address. */</span></div><div class="line">    uint32_t client_addr_len;</div><div class="line"></div><div class="line">    <span class="comment">/* Accept new incoming connection from a TCP client.*/</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga49ede56f180b2bb3e367924f535bb300">cy_socket_accept</a>(socket_handle, &amp;client_addr, &amp;client_addr_len,</div><div class="line">                              &amp;client_handle);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the flag to send message to TCP client.*/</span></div><div class="line">    send_msg_to_client = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Function to handle incoming  message from TCP client. */</span></div><div class="line">cy_rslt_t tcp_server_recv_handler(<a class="code" href="group__group__secure__sockets__typedefs.html#ga12b5aa294d6c930ba50ab730d39ed511">cy_socket_t</a> socket_handle, <span class="keywordtype">void</span> *arg)</div><div class="line">{</div><div class="line">    cy_rslt_t result ;</div><div class="line"></div><div class="line">    <span class="comment">/* Variable to store the number of bytes received. */</span></div><div class="line">    uint32_t bytes_received = 0;</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span> rx_buffer[MAX_TCP_RECV_BUFFER_SIZE];</div><div class="line"></div><div class="line">    <span class="comment">/* Receive incoming message from TCP server. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#gaeb1269bd36384293539dc749095412f7">cy_socket_recv</a>(socket_handle, rx_buffer, MAX_TCP_RECV_BUFFER_SIZE,</div><div class="line">                            <a class="code" href="group__group__secure__sockets__macros.html#ga91444208828cd6b96895d64b879513d4">CY_SOCKET_FLAGS_NONE</a>, &amp;bytes_received);</div><div class="line"></div><div class="line">    <span class="comment">/*Close the connection*/</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga97476da4dcc2f3a411c35b741bf098cc">cy_socket_disconnect</a>(socket_handle, 0);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> snippet_tcp_server()</div><div class="line">{</div><div class="line">    cy_rslt_t result;</div><div class="line"></div><div class="line">    <span class="comment">/* Variable to store the number of bytes sent to the TCP client. */</span></div><div class="line">    uint32_t bytes_sent = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Variable to store the number of bytes received from the TCP client. */</span></div><div class="line">    uint32_t bytes_received = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* IP address and TCP port number of the TCP server */</span></div><div class="line">    <a class="code" href="structcy__socket__sockaddr__t.html">cy_socket_sockaddr_t</a> tcp_server_addr = {</div><div class="line">        .<a class="code" href="structcy__socket__sockaddr__t.html#ac4caf040376b30c85ca9065a20d5616c">ip_address</a>.<a class="code" href="structcy__socket__ip__address__t.html#a935806d84abf86ee6a8dcbfdeb6940a4">ip</a>.<a class="code" href="structcy__socket__ip__address__t.html#a1b68b61521bd0b095ed35bea52f6fd82">v4</a> = TCP_SERVER_IP_ADDRESS,</div><div class="line">        .ip_address.version = <a class="code" href="group__group__secure__sockets__enums.html#gga97cb501a58195859467b126cf2a2789da32785b59f763a33cac58932132a90520">CY_SOCKET_IP_VER_V4</a>,</div><div class="line">        .port = TCP_SERVER_PORT</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="comment">/* Buffer to hold data to be sent to client. */</span></div><div class="line">    <span class="keywordtype">char</span> tx_buffer[] = <span class="stringliteral">&quot;Message to TCP client&quot;</span>;</div><div class="line">    <span class="keywordtype">char</span> rx_buffer[MAX_TCP_RECV_BUFFER_SIZE];</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the Secure Sockets library. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga49a49b4e3b4293aa3855f47ce831ebe2">cy_socket_init</a>();</div><div class="line"></div><div class="line">    <span class="comment">/* Create a TCP socket. If you need a secure connection, create a secure socket</span></div><div class="line"><span class="comment">     * as demonstrated by snippet_create_secure_socket function.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga30bbbf20a277e2a7e622df504b014a4b">cy_socket_create</a>(<a class="code" href="group__group__secure__sockets__macros.html#gacc301fb73845cb915cfacffc1b7d0c23">CY_SOCKET_DOMAIN_AF_INET</a>, <a class="code" href="group__group__secure__sockets__macros.html#gac0610ba6e8fe01ccbaacf89145f9285a">CY_SOCKET_TYPE_STREAM</a>, <a class="code" href="group__group__secure__sockets__macros.html#ga1c6d23edbc333c85d3e7a8702dcf22a1">CY_SOCKET_IPPROTO_TCP</a>, &amp;server_handle);</div><div class="line"></div><div class="line">    <span class="comment">/* Variable used to set socket options. */</span></div><div class="line">    <a class="code" href="structcy__socket__opt__callback__t.html">cy_socket_opt_callback_t</a> tcp_connection_option = {</div><div class="line">        .<a class="code" href="structcy__socket__opt__callback__t.html#a7f321e77df24f3b06ade13f44ce43053">callback</a> = tcp_connection_handler,</div><div class="line">        .arg = NULL</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="comment">/* Register the callback function to handle connection request from a TCP client. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga02e453d715d77075c59d751f6b07ae8f">cy_socket_setsockopt</a>(server_handle, <a class="code" href="group__group__secure__sockets__macros.html#gaf36b6f0f1bc53927d148746fedad7149">CY_SOCKET_SOL_SOCKET</a>,</div><div class="line">                                <a class="code" href="group__group__secure__sockets__macros.html#ga7fd0bff2f890ddab81f7847a1862c325">CY_SOCKET_SO_CONNECT_REQUEST_CALLBACK</a>,</div><div class="line">                                &amp;tcp_connection_option, <span class="keyword">sizeof</span>(<a class="code" href="structcy__socket__opt__callback__t.html">cy_socket_opt_callback_t</a>));</div><div class="line"></div><div class="line">    <span class="comment">/* Variable used to set socket options. */</span></div><div class="line">    <a class="code" href="structcy__socket__opt__callback__t.html">cy_socket_opt_callback_t</a> tcp_recv_option = {</div><div class="line">        .<a class="code" href="structcy__socket__opt__callback__t.html#a7f321e77df24f3b06ade13f44ce43053">callback</a> = tcp_server_recv_handler,</div><div class="line">        .arg = NULL</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="comment">/* Register the callback function to handle messages received from TCP client. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga02e453d715d77075c59d751f6b07ae8f">cy_socket_setsockopt</a>(server_handle, <a class="code" href="group__group__secure__sockets__macros.html#gaf36b6f0f1bc53927d148746fedad7149">CY_SOCKET_SOL_SOCKET</a>,</div><div class="line">                                  <a class="code" href="group__group__secure__sockets__macros.html#gaa05dc49b1682f0682d1a4066c641512d">CY_SOCKET_SO_RECEIVE_CALLBACK</a>,</div><div class="line">                                  &amp;tcp_recv_option, <span class="keyword">sizeof</span>(<a class="code" href="structcy__socket__opt__callback__t.html">cy_socket_opt_callback_t</a>));</div><div class="line"></div><div class="line">    <span class="comment">/* Bind the TCP socket created to Server IP address and to TCP port. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#gac05772b8936d96ec8d8367b661912608">cy_socket_bind</a>(server_handle, &amp;tcp_server_addr, <span class="keyword">sizeof</span>(tcp_server_addr));</div><div class="line"></div><div class="line">    <span class="comment">/* Start listening on the TCP server socket. */</span></div><div class="line">    result = <a class="code" href="group__group__secure__sockets__functions.html#ga1d5c6e81830f6c81f820e02f6d0cf6a0">cy_socket_listen</a>(server_handle, TCP_SERVER_MAX_PENDING_CONNECTIONS);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (;;)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span>(send_msg_to_client)</div><div class="line">        {</div><div class="line">            <span class="comment">/* Send message to TCP client. */</span></div><div class="line">            result = <a class="code" href="group__group__secure__sockets__functions.html#gaf6ba24a0e4e6eb3c24087938aa3ae021">cy_socket_send</a>(client_handle, tx_buffer, strlen(tx_buffer),</div><div class="line">                        <a class="code" href="group__group__secure__sockets__macros.html#ga91444208828cd6b96895d64b879513d4">CY_SOCKET_FLAGS_NONE</a>, &amp;bytes_sent);</div><div class="line"></div><div class="line">            send_msg_to_client = <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        vTaskDelay(RTOS_TASK_TICKS_TO_WAIT);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Cypress Secure Sockets</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
</body>
</html>
